<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hand Control Interaction</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --bg: #000000;
            --orange: #ff9f1c;
            --cream: #ffebaf;
            --line-white: #ffffff;
            --ease: cubic-bezier(0.2, 0.8, 0.2, 1); /* Snappier response for hand tracking */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            user-select: none;
        }

        /* --- Camera & Debug UI --- */
        #input-video {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 80px;
            height: 60px;
            opacity: 0.3; /* Subtle visibility so user knows camera is on */
            border-radius: 8px;
            transform: scaleX(-1); /* Mirror effect */
            z-index: 100;
            object-fit: cover;
            display: none; /* Hidden until started */
        }
        
        #loading-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            transition: opacity 0.5s;
        }

        .start-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #000;
            background: var(--orange);
            border: none;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 0 20px rgba(255, 159, 28, 0.4);
        }

        /* --- Fireworks --- */
        #fireworks-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        /* --- The Container --- */
        .reveal-container {
            position: relative;
            height: 120px;
            width: 80px; 
            display: flex;
            align-items: center;
            justify-content: center;
            /* Transition is faster now to feel responsive to hand */
            transition: width 0.4s var(--ease); 
            z-index: 20;
        }

        .line {
            position: absolute;
            height: 80px;
            width: 5px;
            background: var(--line-white);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
            z-index: 10;
            transition: all 0.4s var(--ease);
        }
        .line-l { left: 0; }
        .line-r { right: 0; }

        .content {
            position: relative;
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }

        .word {
            position: absolute;
            font-size: clamp(1.8rem, 7vw, 3.5rem);
            font-weight: 900;
            color: #ffffff;
            opacity: 0;
            clip-path: inset(0 50% 0 50%); 
            transition: all 0.4s var(--ease);
            white-space: nowrap;
        }

        .heart-icon {
            width: 50px;
            fill: var(--orange);
            filter: drop-shadow(0 0 15px rgba(255, 159, 28, 0.4));
            transition: all 0.4s var(--ease);
        }

        /* --- Stages --- */
        /* Step 1 */
        .stage-1 { width: 300px; }
        .stage-1 .word-i, .stage-1 .word-u { opacity: 1; clip-path: inset(0 0% 0 0%); }
        .stage-1 .word-i { transform: translateX(-100px); }
        .stage-1 .word-u { transform: translateX(100px); }

        /* Step 2 */
        .stage-2 { width: clamp(320px, 95vw, 700px); }
        .stage-2 .line { height: 110px; box-shadow: 0 0 25px var(--orange); }
        .stage-2 .heart-icon { opacity: 0; transform: scale(0) rotate(-90deg); }
        .stage-2 .word-i { opacity: 1; transform: translateX(-220px); clip-path: inset(0 0% 0 0%); }
        .stage-2 .word-love { opacity: 1; transform: scale(1); color: var(--orange); clip-path: inset(0 0% 0 0%); text-shadow: 0 0 20px rgba(255, 159, 28, 0.2); }
        .stage-2 .word-you { opacity: 1; transform: translateX(190px); clip-path: inset(0 0% 0 0%); }

        .pulsing { animation: heartBeat 1.4s infinite; }
        @keyframes heartBeat {
            0% { transform: scale(1); }
            15% { transform: scale(1.15); }
            30% { transform: scale(1); }
            45% { transform: scale(1.15); }
            60% { transform: scale(1); }
        }

        @media (max-width: 500px) {
            .stage-1 { width: 220px; }
            .stage-1 .word-i { transform: translateX(-70px); }
            .stage-1 .word-u { transform: translateX(70px); }
            .stage-2 .word-i { transform: translateX(-110px); }
            .stage-2 .word-you { transform: translateX(110px); }
        }
    </style>
</head>
<body>

    <video id="input-video" playsinline></video>

    <div id="loading-screen">
        <h2 style="margin-bottom: 10px;">Ready?</h2>
        <p>This requires your camera.<br>Show your hand and <b>PINCH</b> your fingers<br>to control the animation.</p>
        <button class="start-btn" onclick="startExperience()">ENABLE CAMERA</button>
        <p id="status-msg" style="margin-top: 15px; font-size: 0.8rem; opacity: 0.7;"></p>
    </div>

    <canvas id="fireworks-canvas"></canvas>

    <div class="reveal-container" id="box">
        <div class="line line-l"></div>
        <div class="line line-r"></div>

        <div class="content">
            <span class="word word-i">I</span>
            <div class="heart-wrapper pulsing" id="heart">
                <svg class="heart-icon" viewBox="0 0 24 24">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
            </div>
            <span class="word word-love">LOVE</span>
            <span class="word word-u">U</span>
            <span class="word word-you">JUDY</span>
        </div>
    </div>

    <script>
        // --- UI & Elements ---
        const box = document.getElementById('box');
        const heart = document.getElementById('heart');
        const videoElement = document.getElementById('input-video');
        const loadingScreen = document.getElementById('loading-screen');
        const statusMsg = document.getElementById('status-msg');
        let camera;

        let currentStep = 0;
        let lastTriggerTime = 0;

        // --- Hand Tracking Logic ---
        function onResults(results) {
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                return; // No hand detected
            }

            // Get the first hand detected
            const landmarks = results.multiHandLandmarks[0];

            // MediaPipe Landmarks: 4 is Thumb Tip, 8 is Index Finger Tip
            const thumbTip = landmarks[4];
            const indexTip = landmarks[8];

            // Calculate Euclidean distance (simple 2D distance ignoring Z for stability)
            // Coordinates are normalized (0.0 to 1.0)
            const distance = Math.sqrt(
                Math.pow(thumbTip.x - indexTip.x, 2) + 
                Math.pow(thumbTip.y - indexTip.y, 2)
            );

            updateAnimationBasedOnDistance(distance);
        }

        // --- Interaction Mapping ---
        // We use "Hysteresis" to prevent flickering when your hand is on the border of a zone
        function updateAnimationBasedOnDistance(dist) {
            
            // Debug log to console if needed
            // console.log(dist);

            let newStep = currentStep;

            // Thresholds
            // < 0.05 : Fingers touching
            // > 0.20 : Fingers spread wide
            
            if (currentStep === 0) {
                if (dist > 0.10) newStep = 1; 
            } else if (currentStep === 1) {
                if (dist < 0.08) newStep = 0;
                if (dist > 0.20) newStep = 2;
            } else if (currentStep === 2) {
                if (dist < 0.18) newStep = 1;
            }

            if (newStep !== currentStep) {
                currentStep = newStep;
                applyState(currentStep);
            }
        }

        function applyState(step) {
            if (step === 0) {
                box.className = 'reveal-container';
                heart.classList.add('pulsing');
            } 
            else if (step === 1) {
                box.className = 'reveal-container stage-1';
                heart.classList.add('pulsing');
            } 
            else if (step === 2) {
                box.className = 'reveal-container stage-2';
                heart.classList.remove('pulsing');
                
                // Only fire fireworks if we haven't recently (prevents spamming)
                const now = Date.now();
                if (now - lastTriggerTime > 1000) {
                    spawnFireworkBatch();
                    lastTriggerTime = now;
                }
            }
        }

        // --- Initialization ---
        async function startExperience() {
            statusMsg.innerText = "Initializing Brain... (this may take a few seconds)";
            
            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 0, // 0 is faster (Lite), 1 is Full. 0 is better for mobile.
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onResults);

            try {
                camera = new Camera(videoElement, {
                    onFrame: async () => {
                        await hands.send({image: videoElement});
                    },
                    width: 640,
                    height: 480
                });
                
                statusMsg.innerText = "Requesting Camera Access...";
                await camera.start();
                
                // If successful:
                videoElement.style.display = "block";
                loadingScreen.style.opacity = 0;
                setTimeout(() => { loadingScreen.style.display = 'none'; }, 500);

            } catch (error) {
                console.error(error);
                statusMsg.innerText = "Error: Camera access denied or not supported. Ensure you are on HTTPS.";
                statusMsg.style.color = "red";
            }
        }

        // --- Fireworks Logic (Optimized) ---
        const canvas = document.getElementById('fireworks-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        const colors = ['#ff9f1c', '#ffebaf', '#ffffff', '#ffb74d'];

        class Particle {
            constructor(x, y) {
                this.x = x; this.y = y;
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 5 + 2;
                this.vx = Math.cos(angle) * velocity;
                this.vy = Math.sin(angle) * velocity;
                this.color = colors[Math.floor(Math.random() * colors.length)];
                this.alpha = 1;
                this.decay = Math.random() * 0.02 + 0.015;
                this.size = Math.random() * 3 + 1;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.vy += 0.05; this.alpha -= this.decay;
            }
            draw() {
                ctx.save(); ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill(); ctx.restore();
            }
        }

        function spawnFireworkBatch() {
            for(let k=0; k<2; k++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * (canvas.height * 0.6);
                for (let i = 0; i < 30; i++) particles.push(new Particle(x, y));
            }
        }

        function animateFireworks() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.update();
                p.draw();
                if (p.alpha <= 0) particles.splice(i, 1);
            }
            requestAnimationFrame(animateFireworks);
        }
        animateFireworks();

    </script>
</body>
</html>
